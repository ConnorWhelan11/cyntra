# Example sleeptime configuration for cyntra-kernel
#
# Add this section to your .cyntra-kernel/config.yaml to enable
# background consolidation of run history into learned context.

version: "1.0"

# ... existing config sections ...

sleeptime:
  enabled: true

  triggers:
    # Run consolidation every N workcell completions
    on_workcell_complete: 5

    # Also run after N seconds of idle time
    on_idle_seconds: 300

    # Trigger immediately after N consecutive failures
    # (helps identify patterns in failure streaks)
    on_failure_streak: 3

  agent:
    # Which toolchain to use for sleeptime processing
    # Recommend a fast/cheap model since this is background work
    toolchain: claude
    model: haiku

    # Quick timeout - consolidation should be fast
    timeout_seconds: 120
    max_tokens: 4000

  blocks:
    # Maximum size per memory block (characters)
    max_size: 8000

    # How many versions to keep in history
    history_versions: 10

    # Which blocks to maintain
    blocks:
      - failure_modes      # Common failure patterns and mitigations
      - successful_patterns # Tool sequences with high success rates
      - exploration_hints   # Areas to explore or avoid
      - trap_signatures     # Dynamics dead-ends
      - genome_patches      # Recommended prompt improvements

  # Processing settings
  max_runs_per_batch: 20      # Max runs to process per consolidation
  min_runs_for_patterns: 5    # Minimum runs before extracting patterns
  pattern_min_frequency: 2    # Minimum occurrences for a pattern

  # Paths (relative to repo root)
  learned_context_dir: .cyntra/learned_context
  sleeptime_state_dir: .cyntra/sleeptime
  runs_dir: .cyntra/runs
  rollouts_dir: .cyntra/rollouts


# Usage in adapters
# -----------------
# The sleeptime system writes to .cyntra/learned_context/*.md
# Primary agents can read these blocks for context injection.
#
# In your adapter, use the hooks:
#
#   from cyntra.sleeptime.hooks import inject_learned_context
#
#   system_prompt = inject_learned_context(config, base_prompt)
#
# Or read specific blocks:
#
#   from cyntra.sleeptime.hooks import get_learned_context_blocks
#
#   context = get_learned_context_blocks(config, ["failure_modes"])
#   if "failure_modes" in context:
#       # Add to tool hints or prompt


# Integration with scheduler
# --------------------------
# In your dispatcher or runner, call the hook after workcell completion:
#
#   from cyntra.sleeptime.hooks import on_workcell_complete
#
#   async def run_workcell(...):
#       ...
#       success = await execute_workcell(...)
#       on_workcell_complete(config, success=success, run_id=run_id)
#
# For async operation:
#
#   from cyntra.sleeptime.hooks import on_workcell_complete_async
#
#   asyncio.create_task(on_workcell_complete_async(config, success))
