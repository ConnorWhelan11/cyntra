{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Fab Gameplay Configuration",
  "description": "Schema for gameplay.yaml configuration files in the Fab World system",
  "type": "object",
  "required": ["schema_version", "world_id"],
  "properties": {
    "schema_version": {
      "type": "string",
      "description": "Schema version for this gameplay configuration",
      "pattern": "^\\d+\\.\\d+$"
    },
    "world_id": {
      "type": "string",
      "description": "World ID this gameplay config belongs to (must match world.yaml)",
      "pattern": "^[a-z][a-z0-9_]*$"
    },
    "player": {
      "type": "object",
      "description": "Player configuration",
      "properties": {
        "controller": {
          "type": "string",
          "enum": ["first_person", "third_person", "top_down", "side_scroller"],
          "description": "Player controller type"
        },
        "capabilities": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": ["walk", "run", "jump", "crouch", "interact", "inventory", "combat", "swim", "climb"]
          },
          "description": "Player capabilities enabled"
        },
        "settings": {
          "type": "object",
          "properties": {
            "move_speed": { "type": "number", "minimum": 0 },
            "run_multiplier": { "type": "number", "minimum": 1 },
            "jump_height": { "type": "number", "minimum": 0 },
            "interact_distance": { "type": "number", "minimum": 0 },
            "gravity": { "type": "number" }
          },
          "additionalProperties": true
        }
      }
    },
    "entities": {
      "type": "object",
      "description": "Entity definitions keyed by entity ID (matches NPC_SPAWN_* or ITEM_SPAWN_* markers)",
      "additionalProperties": {
        "$ref": "#/definitions/entity"
      }
    },
    "interactions": {
      "type": "object",
      "description": "Interaction definitions keyed by interaction ID (matches INTERACT_* markers)",
      "additionalProperties": {
        "$ref": "#/definitions/interaction"
      }
    },
    "triggers": {
      "type": "object",
      "description": "Trigger definitions keyed by trigger ID (matches TRIGGER_* markers)",
      "additionalProperties": {
        "$ref": "#/definitions/trigger"
      }
    },
    "audio_zones": {
      "type": "object",
      "description": "Audio zone definitions keyed by zone ID (matches AUDIO_ZONE_* markers)",
      "additionalProperties": {
        "$ref": "#/definitions/audio_zone"
      }
    },
    "objectives": {
      "type": "array",
      "description": "Quest/objective chain",
      "items": {
        "$ref": "#/definitions/objective"
      }
    },
    "rules": {
      "type": "object",
      "description": "Global game rules",
      "properties": {
        "combat": {
          "type": "object",
          "properties": {
            "enabled": { "type": "boolean" },
            "damage_formula": { "type": "string" },
            "critical_chance": { "type": "number", "minimum": 0, "maximum": 1 }
          }
        },
        "inventory": {
          "type": "object",
          "properties": {
            "max_slots": { "type": "integer", "minimum": 1 },
            "weight_limit": { "type": ["number", "null"] },
            "stack_limit": { "type": "integer", "minimum": 1 }
          }
        },
        "saving": {
          "type": "object",
          "properties": {
            "mode": {
              "type": "string",
              "enum": ["checkpoint", "manual", "autosave", "disabled"]
            },
            "checkpoints": {
              "type": "array",
              "items": { "type": "string" }
            },
            "autosave_interval_seconds": { "type": "integer", "minimum": 30 }
          }
        },
        "time": {
          "type": "object",
          "properties": {
            "enabled": { "type": "boolean" },
            "day_length_minutes": { "type": "number", "minimum": 1 },
            "start_hour": { "type": "integer", "minimum": 0, "maximum": 23 }
          }
        }
      },
      "additionalProperties": true
    }
  },
  "definitions": {
    "entity": {
      "type": "object",
      "properties": {
        "display_name": {
          "type": "string",
          "description": "Human-readable name"
        },
        "type": {
          "type": "string",
          "enum": ["npc", "key_item", "consumable", "equipment", "document", "currency", "container"],
          "description": "Entity type"
        },
        "behavior": {
          "type": "string",
          "enum": ["stationary", "patrol", "patrol_and_interact", "follow", "flee", "wander", "guard"],
          "description": "NPC behavior pattern"
        },
        "patrol_path": {
          "type": "string",
          "description": "ID prefix for WAYPOINT_* markers (e.g., 'main_hall' matches WAYPOINT_main_hall_*)"
        },
        "dialogue": {
          "type": "string",
          "description": "Path to dialogue file (relative to world directory)"
        },
        "schedule": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "time": {
                "type": "array",
                "items": { "type": "integer" },
                "minItems": 2,
                "maxItems": 2,
                "description": "[start_hour, end_hour]"
              },
              "location": { "type": "string" },
              "behavior": { "type": "string" }
            }
          }
        },
        "on_pickup": {
          "type": "array",
          "items": { "$ref": "#/definitions/action" },
          "description": "Actions when item is picked up"
        },
        "unlocks": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Interaction IDs this key item unlocks"
        },
        "effect": {
          "type": "object",
          "description": "Consumable effect",
          "properties": {
            "restore_health": { "type": "number" },
            "restore_stamina": { "type": "number" },
            "buff": { "type": "string" },
            "duration_seconds": { "type": "number" }
          },
          "additionalProperties": true
        },
        "value": {
          "type": "integer",
          "description": "Currency/trade value"
        },
        "weight": {
          "type": "number",
          "description": "Inventory weight"
        },
        "stackable": {
          "type": "boolean",
          "default": false
        },
        "max_stack": {
          "type": "integer",
          "minimum": 1
        }
      },
      "additionalProperties": true
    },
    "interaction": {
      "type": "object",
      "properties": {
        "action": {
          "type": "string",
          "enum": ["examine", "use", "open", "talk", "read", "take", "push", "pull"],
          "description": "Interaction verb"
        },
        "requires": {
          "oneOf": [
            { "type": "null" },
            {
              "type": "object",
              "properties": {
                "item": { "type": "string" },
                "objective_complete": { "type": "string" },
                "flag": { "type": "string" }
              }
            }
          ],
          "description": "Requirement to interact"
        },
        "locked_message": {
          "type": "string",
          "description": "Message shown when requirement not met"
        },
        "result": {
          "type": "array",
          "items": { "$ref": "#/definitions/action" },
          "description": "Actions when interaction succeeds"
        },
        "one_shot": {
          "type": "boolean",
          "default": false,
          "description": "If true, interaction can only be used once"
        }
      },
      "required": ["action", "result"]
    },
    "trigger": {
      "type": "object",
      "properties": {
        "requires": {
          "oneOf": [
            { "type": "null" },
            {
              "type": "object",
              "properties": {
                "item": { "type": "string" },
                "objective_complete": { "type": "string" },
                "flag": { "type": "string" }
              }
            }
          ],
          "description": "Requirement for trigger to activate"
        },
        "on_enter": {
          "type": "array",
          "items": { "$ref": "#/definitions/action" },
          "description": "Actions when player enters trigger"
        },
        "on_exit": {
          "type": "array",
          "items": { "$ref": "#/definitions/action" },
          "description": "Actions when player exits trigger"
        },
        "on_stay": {
          "type": "array",
          "items": { "$ref": "#/definitions/action" },
          "description": "Actions while player stays in trigger"
        },
        "one_shot": {
          "type": "boolean",
          "default": false,
          "description": "If true, trigger only fires once"
        },
        "cooldown_seconds": {
          "type": "number",
          "minimum": 0,
          "description": "Cooldown between activations"
        }
      }
    },
    "audio_zone": {
      "type": "object",
      "properties": {
        "ambient": {
          "type": ["string", "null"],
          "description": "Ambient audio resource path"
        },
        "music": {
          "type": ["string", "null"],
          "description": "Music track resource path"
        },
        "volume": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "default": 1.0
        },
        "fade_time": {
          "type": "number",
          "minimum": 0,
          "default": 1.0,
          "description": "Crossfade duration in seconds"
        },
        "reverb_preset": {
          "type": "string",
          "description": "Audio bus reverb preset"
        }
      }
    },
    "objective": {
      "type": "object",
      "required": ["id", "description", "complete_when"],
      "properties": {
        "id": {
          "type": "string",
          "pattern": "^[a-z][a-z0-9_]*$",
          "description": "Unique objective identifier"
        },
        "description": {
          "type": "string",
          "description": "Player-visible objective text"
        },
        "type": {
          "type": "string",
          "enum": ["main", "side", "discovery", "hidden", "final"],
          "default": "main"
        },
        "requires": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Objective IDs that must be complete before this is active"
        },
        "complete_when": {
          "type": "object",
          "description": "Completion condition",
          "properties": {
            "trigger": { "type": "string" },
            "item_acquired": { "type": "string" },
            "dialogue_complete": { "type": "string" },
            "npc_defeated": { "type": "string" },
            "triggers_activated": {
              "type": "array",
              "items": { "type": "string" }
            },
            "items_collected": {
              "type": "object",
              "properties": {
                "item": { "type": "string" },
                "count": { "type": "integer", "minimum": 1 }
              }
            }
          }
        },
        "hint": {
          "type": "string",
          "description": "Optional hint text"
        },
        "rewards": {
          "type": "object",
          "properties": {
            "xp": { "type": "integer" },
            "items": {
              "type": "array",
              "items": { "type": "string" }
            },
            "unlock": { "type": "string" }
          }
        },
        "on_complete": {
          "type": "array",
          "items": { "$ref": "#/definitions/action" },
          "description": "Actions when objective completes"
        }
      }
    },
    "action": {
      "oneOf": [
        { "type": "string", "enum": ["add_to_inventory"] },
        {
          "type": "object",
          "properties": {
            "trigger": { "type": "string" },
            "show_text": { "type": "string" },
            "show_hint": { "type": "string" },
            "play_animation": { "type": "string" },
            "play_sound": { "type": "string" },
            "play_music": { "type": "string" },
            "fade_music": { "type": "number" },
            "stop_music": { "type": "boolean" },
            "spawn_npc": { "type": "string" },
            "despawn_npc": { "type": "string" },
            "spawn_item": { "type": "string" },
            "consume_item": { "type": "string" },
            "give_item": { "type": "string" },
            "remove_item": { "type": "string" },
            "enable_passage": { "type": "string" },
            "disable_passage": { "type": "string" },
            "open_interface": { "type": "string" },
            "close_interface": { "type": "string" },
            "start_dialogue": { "type": "string" },
            "complete_objective": { "type": "string" },
            "fail_objective": { "type": "string" },
            "set_flag": { "type": "string" },
            "clear_flag": { "type": "string" },
            "teleport_player": { "type": "string" },
            "damage_player": { "type": "number" },
            "heal_player": { "type": "number" },
            "wait_seconds": { "type": "number" },
            "camera_shake": { "type": "number" },
            "fade_out": { "type": "number" },
            "fade_in": { "type": "number" },
            "load_scene": { "type": "string" },
            "end_game": { "type": "string" }
          },
          "minProperties": 1,
          "maxProperties": 1
        }
      ]
    }
  }
}
