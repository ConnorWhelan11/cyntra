# Glia Fab toolchain
# https://mise.jdx.dev

[tools]
python = "3.12"
node = "24.11.0"
bun = "1.1.24"
rust = "1.85"

[env]
# Ensure uv uses mise's Python
UV_PYTHON = "{{env.HOME}}/.local/share/mise/installs/python/3.12/bin/python"

[tasks.dev]
description = "Start desktop app in dev mode"
run = """
cd packages/ag-ui-ext && bun run build
cd apps/desktop && bun run tauri dev
"""

[tasks.kernel]
description = "Run cyntra kernel once"
run = "crates/target/release/cyntra run --once"

[tasks.kernel-py]
description = "Run cyntra kernel (Python) once"
run = "cd kernel && python -m cyntra run --once"

[tasks.build-cyntra]
description = "Build Rust cyntra binary"
run = "cd crates && cargo build --release"

[tasks.test]
description = "Run all tests"
run = """
cd kernel && pytest -v
cd ../apps/desktop && bun run test
"""

[tasks.godot-qa]
description = "Run Godot headless QA tests"
run = """
scripts/godot-qa-runner.sh --project research/backbay-imperium/client --scene res://tests/run_all_tests.tscn
scripts/godot-qa-runner.sh --project research/backbay-imperium/client --scene res://tests/qa_validate_scripts.tscn
"""

[tasks.index-db-up]
description = "Start CocoIndex Postgres (pgvector)"
run = "docker compose -f services/cocoindex/compose.yaml up -d"

[tasks.index-db-down]
description = "Stop CocoIndex Postgres (pgvector)"
run = "docker compose -f services/cocoindex/compose.yaml down"

[tasks.index-neo4j-up]
description = "Start Neo4j (optional graph export)"
run = "docker compose -f services/cocoindex/compose.neo4j.yaml up -d"

[tasks.index-neo4j-down]
description = "Stop Neo4j (optional graph export)"
run = "docker compose -f services/cocoindex/compose.neo4j.yaml down"

[tasks.index-setup]
description = "CocoIndex: setup internal schemas"
run = "uv run --project kernel --extra indexing cyntra index setup --env-file .env --force"

[tasks.index-update]
description = "CocoIndex: incremental update"
run = "uv run --project kernel --extra indexing cyntra index update --env-file .env"

[tasks.index-serve]
description = "CocoIndex: serve query API (reload + CORS for desktop dev)"
run = "uv run --project kernel --extra indexing cyntra index serve --env-file .env --address 127.0.0.1:8020 --cors-local 1420 --live --reload"

[tasks.index-serve-prod]
description = "CocoIndex: serve query API (prod defaults; bind localhost)"
run = "uv run --project kernel --extra indexing cyntra index serve --env-file .env --address 127.0.0.1:8020 --live"
