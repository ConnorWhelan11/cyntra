{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://cyntra/schemas/cyntra/planner_input.schema.json",
  "title": "Cyntra Planner Input",
  "description": "Provenance-first planner input artifact for swarm topology + budgets selection",
  "type": "object",
  "required": [
    "schema_version",
    "created_at",
    "universe_id",
    "job_type",
    "universe_defaults",
    "issue",
    "history",
    "action_space"
  ],
  "properties": {
    "schema_version": { "type": "string", "const": "cyntra.planner_input.v1" },
    "created_at": { "type": "string" },
    "universe_id": { "type": "string" },
    "job_type": { "type": "string" },
    "universe_defaults": {
      "type": "object",
      "properties": {
        "swarm_id": { "type": ["string", "null"] },
        "objective_id": { "type": ["string", "null"] }
      },
      "additionalProperties": false
    },
    "issue": {
      "type": "object",
      "required": [
        "issue_id",
        "dk_priority",
        "dk_risk",
        "dk_size",
        "dk_tool_hint",
        "dk_attempts",
        "tags"
      ],
      "properties": {
        "issue_id": { "type": "string" },
        "dk_priority": {
          "type": "string",
          "enum": ["P0", "P1", "P2", "P3"]
        },
        "dk_risk": {
          "type": "string",
          "enum": ["low", "medium", "high", "critical"]
        },
        "dk_size": {
          "type": "string",
          "enum": ["XS", "S", "M", "L", "XL"]
        },
        "dk_tool_hint": { "type": ["string", "null"] },
        "dk_attempts": { "type": "integer", "minimum": 0 },
        "tags": {
          "type": "array",
          "items": { "type": "string" }
        }
      },
      "additionalProperties": true
    },
    "history": {
      "type": "object",
      "required": ["last_n_similar_runs"],
      "properties": {
        "last_n_similar_runs": {
          "type": "array",
          "items": {
            "type": "object",
            "required": [
              "run_id",
              "started_ms",
              "job_type",
              "domain",
              "action_executed",
              "outcome",
              "runtime"
            ],
            "properties": {
              "run_id": { "type": "string" },
              "started_ms": { "type": "integer", "minimum": 0 },
              "job_type": { "type": "string" },
              "domain": { "type": "string" },
              "action_executed": {
                "type": "object",
                "properties": {
                  "swarm_id": { "type": ["string", "null"] },
                  "max_candidates": { "type": ["integer", "null"] },
                  "max_minutes": { "type": ["integer", "null"] },
                  "max_iterations": { "type": ["integer", "null"] }
                },
                "additionalProperties": false
              },
              "outcome": {
                "type": "object",
                "required": ["status", "fail_codes", "gates"],
                "properties": {
                  "status": {
                    "type": "string",
                    "enum": ["success", "failed", "timeout"]
                  },
                  "fail_codes": {
                    "type": "array",
                    "items": { "type": "string" }
                  },
                  "gates": {
                    "type": "array",
                    "items": {
                      "type": "object",
                      "required": ["name", "passed"],
                      "properties": {
                        "name": { "type": "string" },
                        "passed": { "type": "boolean" },
                        "score": { "type": ["number", "null"] }
                      },
                      "additionalProperties": true
                    }
                  }
                },
                "additionalProperties": true
              },
              "runtime": {
                "type": "object",
                "required": ["duration_ms"],
                "properties": {
                  "duration_ms": { "type": "integer", "minimum": 0 }
                },
                "additionalProperties": true
              },
              "cost_usd_est": { "type": ["number", "null"] },
              "tokens_in": { "type": ["integer", "null"] },
              "tokens_out": { "type": ["integer", "null"] }
            },
            "additionalProperties": true
          }
        }
      },
      "additionalProperties": false
    },
    "action_space": {
      "type": "object",
      "required": [
        "swarm_ids",
        "max_minutes_bins",
        "max_candidates_bins",
        "max_iterations_bins",
        "validity_rules"
      ],
      "properties": {
        "swarm_ids": {
          "type": "array",
          "items": { "type": "string" }
        },
        "max_minutes_bins": {
          "type": "array",
          "items": { "anyOf": [{ "type": "integer" }, { "type": "string" }] }
        },
        "max_candidates_bins": {
          "type": "array",
          "items": { "anyOf": [{ "type": "integer" }, { "type": "string" }] }
        },
        "max_iterations_bins": {
          "type": "array",
          "items": { "anyOf": [{ "type": "integer" }, { "type": "string" }] }
        },
        "validity_rules": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["description"],
            "properties": {
              "description": { "type": "string" }
            },
            "additionalProperties": true
          }
        }
      },
      "additionalProperties": false
    },
    "system_state": {
      "type": ["object", "null"],
      "properties": {
        "active_workcells_bin": { "type": ["string", "null"] },
        "queue_depth_bin": { "type": ["string", "null"] },
        "available_toolchains": {
          "type": ["array", "null"],
          "items": { "type": "string" }
        },
        "toolchain_health": { "type": ["object", "null"] },
        "hour_bucket": { "type": ["string", "null"] },
        "budget_remaining_bin": { "type": ["string", "null"] }
      },
      "additionalProperties": true
    }
  },
  "additionalProperties": false
}
